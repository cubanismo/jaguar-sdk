#====================================================================
#       Macro & Assembler flags
#====================================================================

# BJL/in-RAM start address
STADDR ?= 4000

# BSS follows directly after text and data sections
BSSADDR ?= x

# Default padding and alignment is double-phrase. This can be overriden on the
# make command line, or before including this fragment in a Makefile.
ALIGN ?= d
ASMPAD ?= $(ALIGN)
LINKALIGN ?= $(ALIGN)

# Default to the same optimizations MADMAC used by default:
#  +o0: Absolute long addresses to word
#  +o1: move.l #x,dn/an to moveq
#  +o2: Word branches to short
ASMOPTS ?= +o0 +o1 +o2

BASEASMFLAGS = -fb -g2 -r$(ASMPAD)
# Link flags:
#  -e  - Output using COF file format
#  -g2  - Output source level debugging
#  -r<N> - Align sections to requested boundaries
#  -a  - Absolute section addresses
LINKFLAGS = -e -l -g2 -r$(LINKALIGN) -a $(STADDR) x $(BSSADDR)

# Enable additional logging if requested on the command line.
V ?= 0
VERBOSE =
ifeq ($(V),1)
  VERBOSE += -v
endif
ifeq ($(V),2)
  VERBOSE += -v -v
endif

BASEASMFLAGS += $(VERBOSE)
LINKFLAGS += $(VERBOSE)

# Use rmac and rln as the assembler/linker respectively.
ASM ?= rmac
LINK ?= rln

# Uncomment to use mac and/or aln (Original Atari/brainstorm assembler and
# linker)
#ASM = mac
#LINK = aln

# MADMAC doesn't handle the optimization flags, and has the above defaults
# enabled unconditionally.
ASMFLAGS = $(BASEASMFLAGS)
ifeq ($(ASM),rmac)
  ASMFLAGS += $(ASMOPTS)
endif

# Use newer gcc to build m68k C files.
CFLAGS ?= -O2
CINCLUDES = -I$(JAGSDK)/jaguar/include
CDEFS = -DJAGUAR
CC = m68k-aout-gcc

# Use Atari's/Brainstorm's build of gcc 2.6.3 to build GPU/DSP C files
CC_JRISC = gcc263
CFLAGS_JRISC ?= -b agpu -O2 -fomit-frame-pointer
CFLAGS_DSP = -mDSP

# Add files generated by the build to this to have "make clean" delete them
GENERATED = $(patsubst %.o,g_%.s,$(CGPUOBJS)) $(patsubst %.o,g_%.s,$(CDSPOBJS))

# Default build target
all:
.PHONY: all
